#!/bin/sh

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

OMVVERSION=$(xmlstarlet sel -t -v "//distribution" ${OMV_PRODUCTINFO_FILE} | xmlstarlet unesc)
RELEASE=$(lsb_release -cs)
BACKPORTS_REPO="/etc/apt/sources.list.d/backports.list"

if [ "${RELEASE}" = "squeeze" ]; then
    echo "deb http://backports.debian.org/debian-backports squeeze-backports main non-free" > $BACKPORTS_REPO
else
    echo "deb http://ftp.debian.org/debian ${RELEASE}-backports main contrib non-free" > $BACKPORTS_REPO
fi
echo "deb http://packages.omv-extras.org/debian/ ${OMVVERSION}-backports main" >> $BACKPORTS_REPO

echo "Updating..."
apt-get --quiet update > /dev/null 2>&1

SKIP=false
AMD64=false
ARCH="`/bin/uname -m`"

case "$ARCH" in
    *x86_64*)
        AMD64=true
        ;;
    *486*)
        AMD64=false
        ;;
    *686*)
        AMD64=false
        ;;
    *)
        SKIP=true
        ;;
esac

if $SKIP; then
    echo "Unsupported kernel and/or processor"
else
    case "${RELEASE}" in
        squeeze)
            echo "Install backports 3.2 kernel and headers"
            apt-get -t ${RELEASE}-backports --yes --force-yes --fix-missing install linux-base initramfs-tools
            if $AMD64; then
                apt-get -t ${RELEASE}-backports --yes --force-yes --fix-missing install linux-image-3.2.0-0.bpo.4-amd64 linux-headers-3.2.0-0.bpo.4-all firmware-linux firmware-linux-free
            else
                apt-get -t ${RELEASE}-backports --yes --force-yes --fix-missing install linux-image-3.2.0-0.bpo.4-486 linux-headers-3.2.0-0.bpo.4-all firmware-linux firmware-linux-free
            fi
            ;;
        wheezy)
            echo "Install backports 3.14 kernel and headers"
            apt-get -t ${RELEASE}-backports --yes --force-yes --fix-missing install linux-base initramfs-tools=0.115~bpo70+1
            if $AMD64; then
                apt-get -t ${RELEASE}-backports --yes --force-yes --fix-missing install linux-image-3.14-0.bpo.1-amd64 linux-headers-3.14-0.bpo.1-all firmware-linux firmware-linux-free
            else
                apt-get -t ${RELEASE}-backports --yes --force-yes --fix-missing install linux-image-3.14-0.bpo.1-486 linux-headers-3.14-0.bpo.1-all firmware-linux firmware-linux-free
            fi
            ;;
    esac
    echo "..."
    echo "Please reboot to use new kernel"
fi
